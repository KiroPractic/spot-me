@page "/data"
@using SpotMe.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject StreamingHistoryImportService ImportService
@inject DatabaseStatsService StatsService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>SpotMe - Import Data</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No Spotify Data Found
                    </h3>
                </div>
                <div class="card-body">
                    @if (_isLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Checking import status...</p>
                        </div>
                    }
                    else if (_importStats?.IsImported == true)
                    {
                        <div class="alert alert-success">
                            <h5><i class="bi bi-check-circle me-2"></i>Data Already Imported!</h5>
                            <p>You have <strong>@_importStats.DatabaseEntryCount.ToString("N0")</strong> streaming history entries in the database.</p>
                            <p>Your stats are now loading super fast! üöÄ</p>
                        </div>
                        
                        <div class="d-grid">
                            <a href="/stats" class="btn btn-primary btn-lg">
                                <i class="bi bi-graph-up me-2"></i>
                                View Your Stats
                            </a>
                        </div>
                    }
                    else
                    {
                        @if (_importStats?.JsonEntryCount > 0)
                        {
                            <div class="alert alert-warning">
                                <p><strong>Ready to Import:</strong> Found @_importStats.JsonEntryCount.ToString("N0") entries in your JSON files.</p>
                            </div>
                            
                            @if (_isImporting)
                            {
                                <div class="text-center">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Importing...</span>
                                    </div>
                                    <p class="mt-2">Importing your data to database...</p>
                                    <p class="text-muted">This may take a few minutes for large datasets.</p>
                                </div>
                            }
                            else
                            {
                                <div class="d-grid">
                                    <button @onclick="StartImport" class="btn btn-success btn-lg">
                                        <i class="bi bi-database-up me-2"></i>
                                        Import to Database
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert-green-container">
                                <div class="alert-content">
                                    <p>We couldn't find any of your Spotify streaming history data.</p>
                                    <p>Please upload your Spotify JSON files first using the file upload.</p>
                                </div>
                            </div>
                        }
                    }

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger mt-3">
                            <strong>Error:</strong> @_errorMessage
                        </div>
                    }

                    @if (_importResult != null && _importResult.Success)
                    {
                        <div class="alert alert-success mt-3">
                            <h5><i class="bi bi-check-circle me-2"></i>Import Successful!</h5>
                            <p>Successfully imported <strong>@_importResult.ImportedCount.ToString("N0")</strong> entries.</p>
                            @if (_importResult.ErrorCount > 0)
                            {
                                <p class="text-warning">‚ö†Ô∏è @_importResult.ErrorCount entries had errors and were skipped.</p>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Instructions Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">How to Get Your Spotify Data</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>
                            <strong>Visit Spotify's Privacy Settings:</strong><br>
                            <a href="https://www.spotify.com/account/privacy/" target="_blank" class="text-primary">
                                spotify.com/account/privacy/
                                <i class="bi bi-box-arrow-up-right ms-1"></i>
                            </a>
                        </li>
                        <li>
                            <strong>Request Your Data:</strong><br>
                            Scroll down to "Download your data" and click "Request data download"
                        </li>
                        <li>
                            <strong>Select Extended Streaming History:</strong><br>
                            Make sure to check "Extended streaming history" for detailed data
                        </li>
                        <li>
                            <strong>Wait for Email:</strong><br>
                            Spotify will email you when ready (usually 1-30 days)
                        </li>
                        <li>
                            <strong>Upload JSON Files:</strong><br>
                            Extract the ZIP and upload the <code>Streaming_History_Audio_*.json</code> files
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ImportStats? _importStats;
    private ImportResult? _importResult;
    private bool _isLoading = true;
    private bool _isImporting = false;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check if user is authenticated
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated != true)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await LoadImportStats();
        }
    }

    private async Task LoadImportStats()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // For now, we'll simulate checking import stats
            // In the future, this would check for uploaded JSON files
            _importStats = new ImportStats
            {
                JsonEntryCount = 0, // No JSON files for now
                DatabaseEntryCount = await StatsService.GetImportedEntryCountAsync(),
                IsImported = await StatsService.HasImportedDataAsync()
            };
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error checking import status: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task StartImport()
    {
        if (_importStats?.JsonEntryCount <= 0) return;

        _isImporting = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var userId = "current-user"; // This would come from auth service
            _importResult = await ImportService.ImportUserStreamingHistoryAsync(userId);
            
            if (_importResult.Success)
            {
                await LoadImportStats(); // Refresh stats
            }
            else
            {
                _errorMessage = _importResult.ErrorMessage ?? "Import failed for unknown reason";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error during import: {ex.Message}";
        }
        finally
        {
            _isImporting = false;
            StateHasChanged();
        }
    }
}